{% extends "base.html" %}
{% block title %}Progress | TrainSphere{% endblock %}
{% block banner_title %}Progress{% endblock %}

{% block content %}

  <div class="card">
    {% if edit_workout %}
      <h2>Edit workout</h2>
      <p class="small">Update the workout and save changes.</p>
    {% else %}
      <h2>Log workout</h2>
      <p class="small">Choose a workout template, edit sets/reps/weight, and save.</p>
    {% endif %}

    <form method="post" id="workoutForm">
      {% if edit_workout %}
        <input type="hidden" name="workout_id" value="{{ edit_workout.id }}">
      {% endif %}

      <label>Workout type</label>
      <select name="workout_type" id="workoutType" onchange="loadTemplate()">
        {% for key in workout_templates.keys() %}
          <option value="{{ key }}"
            {% if edit_workout and edit_workout.workout_type == key %}selected{% endif %}
          >{{ key }}</option>
        {% endfor %}
      </select>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <div>
          <label>Category</label>
          <select name="category" id="workoutCategory">
            {% for c in categories %}
              <option value="{{ c }}"
                {% if edit_workout and edit_workout.category == c %}selected{% endif %}
              >{{ c }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <div>
          <label>Duration (minutes)</label>
          <input name="duration_minutes" id="workoutDuration" type="number" min="1"
                 placeholder="e.g. 45"
                 value="{{ edit_workout.duration_minutes if edit_workout and edit_workout.duration_minutes is not none else '' }}">
        </div>
        <div>
          <label>Date</label>
          <input name="workout_date" id="workoutDate" type="date"
                 value="{{ edit_workout.workout_date if edit_workout else '' }}">
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <div>
          <label>Performance (1..10)</label>
          <input name="performance_rating" id="workoutPerformance" type="number" min="1" max="10"
                 placeholder="e.g. 8"
                 value="{{ edit_workout.performance_rating if edit_workout and edit_workout.performance_rating is not none else '' }}">
        </div>
        <div>
          <label>Feeling (1..10)</label>
          <input name="feeling_rating" id="workoutFeeling" type="number" min="1" max="10"
                 placeholder="e.g. 7"
                 value="{{ edit_workout.feeling_rating if edit_workout and edit_workout.feeling_rating is not none else '' }}">
        </div>
      </div>

      <label>Notes</label>
      <textarea name="notes" id="workoutNotes" placeholder="Add notes here...">{% if edit_workout %}{{ edit_workout.notes or '' }}{% endif %}</textarea>

      <hr class="sep">

      <h2>Exercises</h2>
      <p class="small">You can edit rows.</p>

      {% if edit_workout %}
        <div id="exerciseRows" data-edit-mode="1">
          {% for ex in edit_exercises %}
            <div class="card" style="box-shadow:none;margin-top:10px;">
              <label>Exercise name</label>
              <input name="exercise_name[]" value="{{ ex.exercise_name }}" required>

              <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
                <div>
                  <label>Sets</label>
                  <input name="sets[]" type="number" min="1" value="{{ ex.sets or '' }}">
                </div>
                <div>
                  <label>Reps</label>
                  <input name="reps[]" type="number" min="1" value="{{ ex.reps or '' }}">
                </div>
                <div>
                  <label>Weight (kg)</label>
                  <input name="weight_kg[]" type="number" step="0.5" value="{{ ex.weight_kg or '' }}">
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div id="exerciseRows" data-edit-mode="0"></div>
      {% endif %}

      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;">
        <!-- Add Exercise –º–∞—Ö–Ω–∞—Ç –∏–∑—Ü—è–ª–æ -->
        <button type="button" class="btn" onclick="clearDraft()">Clear draft</button>

        {% if edit_workout %}
          <button class="btn pink" type="submit">Save changes</button>
          <a class="btn secondary" href="{{ url_for('progress.page') }}">Cancel</a>
        {% else %}
          <button class="btn pink" type="submit">Finish</button>
        {% endif %}
      </div>
    </form>
  </div>

  {% if recent %}
    <div class="card" style="margin-top:16px;">
      <h2>Workouts</h2>

      <form method="get" class="workout-filters">
        <div class="workout-filters-grid">
          <div>
            <label>Period</label>
            <select name="period">
              <option value="week" {% if filters.period=='week' %}selected{% endif %}>Last 7 days</option>
              <option value="month" {% if filters.period=='month' %}selected{% endif %}>This month</option>
            </select>
          </div>

          <div>
            <label>Category</label>
            <select name="category">
              <option value="" {% if not filters.category %}selected{% endif %}>All</option>
              {% for c in categories %}
                <option value="{{ c }}" {% if filters.category==c %}selected{% endif %}>{{ c }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="workout-filters-actions">
          <button class="btn" type="submit">Apply filters</button>
          <a class="btn secondary" href="{{ url_for('progress.page') }}">Reset</a>
        </div>
      </form>

      <div class="workout-history">
        {% for w in recent %}
          <div style="padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff;margin-bottom:10px;">
            <b>{{ w.workout_type }}</b>

            {% if w.category %}
              <div class="small">category: {{ w.category }}</div>
            {% endif %}

            <div class="small">
              {% if w.duration_minutes %}{{ w.duration_minutes }} min ¬∑ {% endif %}
              performance={{ w.performance_rating or "-" }}/10 ¬∑ feeling={{ w.feeling_rating or "-" }}/10
            </div>

            {% set ex_list = recent_ex.get(w.id) %}
            {% if ex_list %}
              <div class="small" style="margin-top:6px;">
                {% for ex in ex_list %}
                  ‚Ä¢ {{ ex.exercise_name }} ({{ ex.sets }}x{{ ex.reps }}, {{ ex.weight_kg }}kg)<br>
                {% endfor %}
              </div>
            {% endif %}

            {% if w.notes %}
              <div class="small">üìù {{ w.notes }}</div>
            {% endif %}

            <div class="small" style="opacity:.6">{{ w.workout_date }}</div>

            <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;">
              <a class="btn secondary" href="{{ url_for('progress.page') }}?edit={{ w.id }}">Edit</a>

              <form method="post" action="{{ url_for('progress.delete', workout_id=w.id) }}"
                    onsubmit="return confirm('Delete this workout?');">
                <button class="btn" type="submit">Delete</button>
              </form>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <script id="workout-templates-data" type="application/json">
    {{ workout_templates | tojson }}
  </script>
  <script src="{{ url_for('static', filename='progress.js') }}"></script>

{% endblock %}
